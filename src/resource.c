#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <sqlite3.h>
#include "include/define.h"

int codepoint_dump[] = {
	0x0000, 0x0001, 0x0002, 0x0003, 0x0004, 0x0005, 0x0006, 0x0007,
	0x0008, 0x0009, 0x000A, 0x000B, 0x000C, 0x000D, 0x000E, 0x000F,
	0x0010, 0x0011, 0x0012, 0x0013, 0x0014, 0x0015, 0x0016, 0x0017,
	0x0018, 0x0019, 0x001A, 0x001B, 0x001C, 0x001D, 0x001E, 0x001F,
	0x0020, 0x0021, 0x0022, 0x0023, 0x0024, 0x0025, 0x0026, 0x0027,
	0x0028, 0x0029, 0x002A, 0x002B, 0x002C, 0x002D, 0x002E, 0x002F,
	0x0030, 0x0031, 0x0032, 0x0033, 0x0034, 0x0035, 0x0036, 0x0037,
	0x0038, 0x0039, 0x003A, 0x003B, 0x003C, 0x003D, 0x003E, 0x003F,
	0x0040, 0x0041, 0x0042, 0x0043, 0x0044, 0x0045, 0x0046, 0x0047,
	0x0048, 0x0049, 0x004A, 0x004B, 0x004C, 0x004D, 0x004E, 0x004F,
	0x0050, 0x0051, 0x0052, 0x0053, 0x0054, 0x0055, 0x0056, 0x0057,
	0x0058, 0x0059, 0x005A, 0x005B, 0x005C, 0x005D, 0x005E, 0x005F,
	0x0060, 0x0061, 0x0062, 0x0063, 0x0064, 0x0065, 0x0066, 0x0067,
	0x0068, 0x0069, 0x006A, 0x006B, 0x006C, 0x006D, 0x006E, 0x006F,
	0x0070, 0x0071, 0x0072, 0x0073, 0x0074, 0x0075, 0x0076, 0x0077,
	0x0078, 0x0079, 0x007A, 0x007B, 0x007C, 0x007D, 0x007E, 0x007F,
//shavian block
	0x10450, 0x10451, 0x10452, 0x10453, 0x10454, 0x10455, 0x10456, 0x10457,
	0x10458, 0x10459, 0x1045A, 0x1045B, 0x1045C, 0x1045D, 0x1045E, 0x1045F,
	0x10460, 0x10461, 0x10462, 0x10463, 0x10464, 0x10465, 0x10466, 0x10467,
	0x10468, 0x10469, 0x1046A, 0x1046B, 0x1046C, 0x1046D, 0x1046E, 0x1046F,
	0x10470, 0x10471, 0x10472, 0x10473, 0x10474, 0x10475, 0x10476, 0x10477,
	0x10478, 0x10479, 0x1047A, 0x1047B, 0x1047C, 0x1047D, 0x1047E, 0x1047F
};

struct res *current_res;
void unload_current_res(void) {
	UnloadTexture(current_res->menu_background);	

	UnloadSound(current_res->select_sound);

	UnloadFont(current_res->font);
}

struct res default_res;
void assign_default()
{
	default_res.menu_background =	LoadTexture("assets/default/menu_background.png"),

	default_res.select_sound =	LoadSound("assets/default/select.wav"),


	default_res.font =	LoadFontEx("assets/default/font/"
		"DoolittleGaramond-Regular.otf",
		50, codepoint_dump, 
		sizeof(codepoint_dump) / sizeof(codepoint_dump[0]));


	SetTextureFilter(default_res.font.texture, TEXTURE_FILTER_BILINEAR);
}

struct config config_current;
int config_retrieve(void)
{
	sqlite3 *db;
	sqlite3_stmt *stmt;

	config_current.language = NULL;

	if(sqlite3_open("config.db", &db) != SQLITE_OK) {
		fprintf(stderr, "Cannot open database: %s\n", sqlite3_errmsg(db));
		sqlite3_close(db);
		return 1;
	}

	sqlite3_prepare_v2(db,
		"SELECT value FROM main WHERE option='letterbox'",
		-1, &stmt, NULL);
	sqlite3_step(stmt);
	config_current.letterbox = sqlite3_column_int(stmt, 0);
	sqlite3_finalize(stmt);

	sqlite3_prepare_v2(db,
		"SELECT value FROM main WHERE option='fullscreen'",
		-1, &stmt, NULL);
	sqlite3_step(stmt);
	config_current.fullscreen = sqlite3_column_int(stmt, 0);
	sqlite3_finalize(stmt);

	//strings

	sqlite3_prepare_v2(db,
		"SELECT value FROM string WHERE option='language'",
		-1, &stmt, NULL);
	sqlite3_step(stmt);
	config_current.language = 
		malloc(strlen((char*)sqlite3_column_text(stmt, 0) + 1));
	strcpy(config_current.language, (char*)sqlite3_column_text(stmt, 0));
	sqlite3_finalize(stmt);

	printf("language: %s\n", config_current.language);

	sqlite3_close(db);
	return 0;
}

void config_free(struct config *config_target)
{
	free(config_target->language);
}

struct config config_buffer;
